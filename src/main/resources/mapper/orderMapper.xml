<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.firstSpring.dao.order.OrderMapper">
    
    <update id="increaseInvAmnt" parameterType="map">
        UPDATE prod_col
        SET inv_amnt = inv_amnt + #{qty}
        WHERE prod_no = #{prod_no} and col_no = #{col_no}
    </update>

    <update id="decreaseInvAmnt" parameterType="map">
        UPDATE prod_col
        SET inv_amnt = inv_amnt - #{qty}
        WHERE prod_no = #{prod_no} and col_no = #{col_no}
    </update>

    <update id="cancelOrder" parameterType="OrderDto">
        UPDATE orders
        SET ord_st_cd = 'C',
            cnl_dt = DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s'),
            last_mod_dt = DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s'),
            last_mod_id = #{cust_id}
        WHERE ord_no = #{ord_no}
    </update>

    <insert id="insertItem" parameterType="OrderItemDto">
        INSERT INTO order_item
        (
            ord_no,
            prod_no,
            col_no,
            qty,
            prod_name,
            price,
            frst_reg_dt,
            frst_reg_id,
            last_mod_dt,
            last_mod_id)
        VALUES
            (
                #{ord_no},
                #{prod_no},
                #{col_no},
                #{qty},
                #{prod_name},
                #{price},
                #{frst_reg_dt},
                #{frst_reg_id},
                #{last_mod_dt},
                #{last_mod_id})
    </insert>

    <insert id="insertItemReturn" parameterType="java.util.HashMap">
        INSERT INTO order_item
            (
            ord_no,
            prod_no,
            col_no,
            qty,
            prod_name,
            price,
            frst_reg_dt,
            frst_reg_id,
            last_mod_dt,
            last_mod_id)
        VALUES
            (
            #{orderDto.ord_no_return},
            #{orderItemDto.prod_no},
            #{orderItemDto.col_no},
            #{orderItemDto.qty},
            #{orderItemDto.prod_name},
            #{orderItemDto.price},
            #{orderItemDto.frst_reg_dt},
            #{orderItemDto.frst_reg_id},
            #{orderItemDto.last_mod_dt},
            #{orderItemDto.last_mod_id})
    </insert>

    <insert id="insertOrder" parameterType="OrderDto">
        INSERT INTO orders
            (cust_id,
             ord_st_cd,
             ord_dt,
             cnl_dt,
             frst_reg_dt,
             frst_reg_id,
             last_mod_dt,
             last_mod_id)
        VALUES
            (#{cust_id},
             #{ord_st_cd},
             #{ord_dt},
             #{cnl_dt},
             #{frst_reg_dt},
             #{frst_reg_id},
             #{last_mod_dt},
             #{last_mod_id})

        <selectKey keyProperty="ord_no_return" resultType="int" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>

    <select id="selectProdName" parameterType="int" resultType="String">
        SELECT name
        FROM product
        WHERE prod_no = #{prod_no}
    </select>

    <select id="selectPrice" parameterType="String" resultType="int">
        SELECT price
        FROM product
        WHERE prod_no = #{prod_no}
    </select>

    <select id="selectItem" parameterType="int" resultType="OrderItemDto">
        SELECT o.ord_item_no,
               o.ord_no,
               o.prod_no,
               o.col_no,
               o.qty,
               o.prod_name,
               o.price,
               c.col_name,
               o.frst_reg_dt,
               o.frst_reg_id,
               o.last_mod_dt,
               o.last_mod_id
        FROM order_item AS o
        INNER JOIN prod_col AS c
        ON o.prod_no = c.prod_no and o.col_no = c.col_no
        WHERE o.ord_no = #{ord_no}
        ORDER BY ord_item_no ASC
    </select>

    <select id="selectOrder" parameterType="String" resultType="OrderDto">
        SELECT ord_no,
               cust_id,
               ord_st_cd,
               ord_dt,
               cnl_dt,
               frst_reg_dt,
               frst_reg_id,
               last_mod_dt,
               last_mod_id
        FROM orders
        WHERE cust_id = #{cust_id}
        ORDER BY ord_dt DESC
    </select>

    <select id="selectOrderPage" parameterType="map" resultType="OrderDto">
        SELECT ord_no,
               cust_id,
               ord_st_cd,
               ord_dt,
               cnl_dt,
               frst_reg_dt,
               frst_reg_id,
               last_mod_dt,
               last_mod_id
        FROM orders
        WHERE cust_id = #{cust_id}
        ORDER BY ord_dt DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="countOrder" parameterType="String" resultType="int">
        SELECT count(*)
        FROM orders
        WHERE cust_id = #{cust_id}
    </select>

    <select id="maxOrdNo" resultType="int">
        SELECT MAX(ord_no)
        FROM orders
    </select>

    <select id="maxOrdItemNo" resultType="int">
        SELECT MAX(ord_no)
        FROM order_item
    </select>

</mapper>
